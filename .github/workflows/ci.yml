name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: Run clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Run tests
        run: cargo test --workspace --all-features

  test-features:
    name: Test Features (${{ matrix.features }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        features:
          - ""  # default features
          - "contract-posting"
          - "contract-posting,signed-envelopes"
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Run tests with features
        run: |
          if [ -z "${{ matrix.features }}" ]; then
            cargo test -p l2-batcher -p l2-node
          else
            cargo test -p l2-batcher -p l2-node --features "${{ matrix.features }}"
          fi
      - name: Check build with features
        run: |
          if [ -z "${{ matrix.features }}" ]; then
            cargo build -p l2-node --release
          else
            cargo build -p l2-node --release --features "${{ matrix.features }}"
          fi

  openapi-drift:
    name: OpenAPI Drift Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check OpenAPI drift
        run: bash scripts/check_openapi_drift.sh

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build release
        run: cargo build --workspace --release

  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install cargo-audit
        run: cargo install cargo-audit
      - name: Run security audit
        run: cargo audit

  deny:
    name: Cargo Deny
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: EmbarkStudios/cargo-deny-action@v2

  solidity:
    name: Solidity Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: integrations/eth-oracle/contracts
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: stable
      - name: Build contracts
        run: forge build
      - name: Run tests
        run: forge test -vvv

  settlement-lifecycle:
    name: Settlement Lifecycle Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Run settlement state machine tests
        run: cargo test -p l2-storage settlement --all-features
      - name: Run reconciler tests
        run: cargo test -p l2-batcher reconciler --all-features
      - name: Run fee model tests
        run: cargo test -p l2-core fees --all-features
      - name: Verify crash-safe storage operations
        run: |
          # Test that storage operations are atomic and survive simulated crashes
          cargo test -p l2-storage --all-features -- --test-threads=1 settlement_state
      - name: Test feature combinations
        run: |
          # Ensure settlement works with contract-posting
          cargo test -p l2-batcher --features contract-posting reconciler
          # Ensure settlement works with signed-envelopes
          cargo test -p l2-batcher --features signed-envelopes reconciler
          # Ensure settlement works with all features
          cargo test -p l2-batcher --features "contract-posting,signed-envelopes" reconciler

  fuzz:
    name: Fuzz Tests (nightly, optional)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz
      - name: Build fuzz targets
        run: |
          cd fuzz
          cargo +nightly fuzz build
      - name: Run short fuzz (10s per target)
        run: |
          cd fuzz
          for target in fuzz_rlp_receipt fuzz_mpt_proof fuzz_external_proof fuzz_fin_action; do
            echo "Fuzzing $target..."
            timeout 10s cargo +nightly fuzz run "$target" -- -max_total_time=10 || true
          done

  # Summary job that depends on all checks
  ci-success:
    name: CI Success
    needs: [fmt, clippy, test, test-features, openapi-drift, build, audit, deny, solidity, settlement-lifecycle]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.fmt.result }}" != "success" ]] || \
             [[ "${{ needs.clippy.result }}" != "success" ]] || \
             [[ "${{ needs.test.result }}" != "success" ]] || \
             [[ "${{ needs.test-features.result }}" != "success" ]] || \
             [[ "${{ needs.openapi-drift.result }}" != "success" ]] || \
             [[ "${{ needs.build.result }}" != "success" ]] || \
             [[ "${{ needs.audit.result }}" != "success" ]] || \
             [[ "${{ needs.deny.result }}" != "success" ]] || \
             [[ "${{ needs.solidity.result }}" != "success" ]] || \
             [[ "${{ needs.settlement-lifecycle.result }}" != "success" ]]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "All CI checks passed!"
